const { makeHttpRequest } = require('./http-client.js');
const { z } = require('zod');

// Hardening controls for outgoing HTTP
const ALLOWED_METHODS = new Set(
  String(process.env.OPENAPI_MCP_ALLOWED_METHODS || 'GET,POST,PUT,PATCH,DELETE')
    .split(',')
    .map(s => s.trim().toUpperCase())
    .filter(Boolean)
);

const ALLOWED_PATH_PATTERNS = String(process.env.OPENAPI_MCP_ALLOWED_PATHS || '.*')
  .split(',')
  .map(s => s.trim())
  .filter(Boolean);

const RATE_LIMIT = Number(process.env.OPENAPI_MCP_RATE_LIMIT || 0); // average per window
const RATE_BURST = Number(process.env.OPENAPI_MCP_RATE_BURST || RATE_LIMIT || 0); // token bucket burst
const RATE_WINDOW_MS = Number(process.env.OPENAPI_MCP_RATE_WINDOW_MS || 60000);
const GLOBAL_CONCURRENCY = Number(process.env.OPENAPI_MCP_CONCURRENCY || 0); // 0 = unlimited
const PER_PATH_CONCURRENCY = Number(process.env.OPENAPI_MCP_CONCURRENCY_PER_PATH || 0);

let rateWindowStart = Date.now();
let rateCount = 0;
let tokens = RATE_BURST;
let lastRefill = Date.now();

const inflight = new Set(); // holds unique Symbols
const inflightPerPath = new Map();

